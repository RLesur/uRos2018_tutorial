---
title: "Finding and handling data errors"
subtitle: "errorlocate" 
author: "Edwin de Jonge and Mark van der Loo"
date: "uRos2018 Tutorial Session, The Hague"
output:
  beamer_presentation:
    keep_tex: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = FALSE)
library(errorlocate)
library(magrittr)
```

## Packages

To run the examples please install:

```{r}
install.packages("errorlocate")
```

## Finding errors in records.

\begin{center}
\includegraphics[width=\textwidth]{fig/valuechain}
\end{center}

## Validation rules?

As we saw package `validate` allows to:

- formulate explicit data rule that data must conform to:

```{r}
library(validate)
rules <- validator(
  age >= 0, 
  age < 150,
  if (driver_license == TRUE) age >= 16
)
```

## Explicit validation rules:

- Give a clear overview what the data must conform to.
- Can be used to reason about.
- Can be used to fix/correct data!
- Find error, and when found correct it.

### Note:

- Manual editing is error prone, not reproducible and not feasible for large data sets.
- Large rule sets have (very) complex behavior, e.g. entangled rules: adjusting one value may 
invalidate other rules.

## 

### `validate` tells us:

- which **records** are **invalid**
- which data **rules** are **violated**.

### `errorlocate` tells us:

- which field/**variable**(s) should be fixed to make a record valid.

## Data example

```{r}
rules <- validator(
  age >= 0, 
  age < 150,
  if (driver_license == TRUE) age >= 16
)

# invalid data
car_owners <- data.frame(age = 160, driver_license = TRUE)
```

a) Which variable is incorrect? Why?

## Data example

```{r}
rules <- validator(
  age >= 0, 
  age < 150,
  if (driver_license == TRUE) age >= 16
)

# invalid data
car_owners <- data.frame(age = 160, driver_license = TRUE)
```

Clearly `age` is incorrect, because it violates our constraint.

## Data example 2

```{r}
rules <- validator(
  age >= 0, 
  age < 150,
  if (driver_license == TRUE) age >= 16
)

car_owners <- data.frame(age = 10, driver_license = TRUE)
```

a) Which variable is incorrect? Why?

## Data example 2

```{r}
rules <- validator(
  age >= 0, 
  age < 150,
  if (driver_license == TRUE) age >= 16
)

car_owners <- data.frame(age = 10, driver_license = TRUE)
```

_It depends on the quality of `age` and `driver_license`_ we can add more weight to `age` if we think
that variable has better quality.

## Error localization

> Error localization is a procedure that points out fields in a data set 
that can be altered or imputed in such a way that all validation rules
can be satisfied.


## Assignment: 

```{r}
rules <- validator(
  if (married == TRUE) age >= 16,
  if (attends == "kindergarten") age <= 6
) 

persons <- data.frame( age     = 3
                     , married = TRUE
                     , attends = "kindergarten"
                     )
```

a) check with `validate` which rules are violated.
b) What should be changed to this record to "correct" it? Why? 

## Feligi Holt formalism:

> Find the minimal (weighted) number of variables that cause the invalidation of the data rules.

Makes sense if is no further knowledge on the error mechanism! (But there are exceptions...)

Implemented in `errorlocate` (second generation of `editrules`).

## `errorlocate::locate_errors`

```{r, eval=TRUE}
locate_errors( data.frame( age  = 3
                  , married = TRUE
                  , attends = "kindergarten"
                  )
     , validator( if (married == TRUE) age >= 16
                , if (attends == "kindergarten") age <= 6
                )
     )$errors
```

## Assignment with small examples

a) Run `locate_errors` on `data.frame(age = 26, married = TRUE, attends= "kindergarten")`. What is the error? Look at the errors. 
b) Run `locate_errors` on `data.frame(age = 15, married = TRUE, attends= "kindergarten")`. What is the error?
Do you agree? Look at the errors. 
c) Run `locate_errors` with the `rules_dl` (!) on `data.frame(age=10,driver_license = TRUE)` data set. Express more confidence in the variable `age` by supplying a `weight` to `locate_errors` (`weight = c("age" = 2, "driver_license" = 1)`)

## Removing errors

- Detecting errors is very useful, but then what? 
- Fixing philosophy is: 
  - Find erroneuous values.
  - Remove them (i.e. make them `NA`).
  - Impute them with sensible values.
  
### Note
We could also remove erroneous records completely, but often this result in _over-deletion_ and introduces a _bias_.

## `errorlocate::replace_errors`

- Locates errors and replaces them with `NA`.

```{r, eval=TRUE}
replace_errors( 
    data.frame( age     = 3
              , married = TRUE
              , attends = "kindergarten"
              )
  , validator( if (married == TRUE) age >= 16
             , if (attends == "kindergarten") age <= 6
             )
)
```
## Assignment

a) Use the data set `retailers` from validation.
b) Use validate to find out which records are `faulty`
c) use `locate_errors` to find some errors.
d) use `replace_errors` to "fix" the data set.

```{r, include = FALSE}
data(retailers, package="validate")
rules <- validator(
  to_pos = turnover >= 0
  , or_pos = other.rev >= 0
  , balance = turnover + other.rev == total.rev)
rules

locate_errors(retailers, rules)
```

## Internal workings:

`errorlocate`:

- translates error localization problem into a **mixed integer problem**, which
is solved with `lpsolveAPI`.

- contains a small framework for implementing your own error localization algorithms.


## Pipe friendly

The `replace_errors` function is pipe friendly:

```{r}
rules <- validator(age < 150)

data_noerrors <- 
  data.frame(age=160, driver_license = TRUE) %>% 
  replace_errors(rules)

errors_removed(data_noerrors) # contains errors removed
```

